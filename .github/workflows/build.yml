# This is a basic workflow to help you get started with Actions

name: Build firmware for ELECOM WAB-I1750-PS

# Controls when the workflow will run
on:
  schedule:
    - cron: '23 1 * * *'

  workflow_dispatch:

jobs:
  build:
  
    runs-on: ubuntu-latest

    steps:
      - name: Check environment
        run: |
          whoami
          echo $(nproc)

      - name: Remove unused packages and other cleanup
        run: |
          sudo apt -y purge --auto-remove --purge php* mysql* mono* snapd* dotnet* aspnetcore* firefox* google*
          sudo apt -y autopurge
          sudo apt -y autoclean
          sudo apt -y clean
          sudo rm -rf /usr/local/lib/android/sdk
          sudo rm -rf /usr/local/share/chromedriver-linux64
          sudo rm -rf /usr/local/share/edge_driver
          sudo rm -rf /usr/local/share/gecko_driver
          sudo rm -rf /usr/share/java
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/local/share/vcpkg
          df -h

      - name: Install packages
        run: |
          sudo apt -y update
          sudo apt -y full-upgrade --auto-remove --purge
          sudo apt -y install --auto-remove --purge build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget
          sudo apt -y clean

      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: config

      - name: Clone OpenWrt repository and setup to build
        run: |
          git clone --depth=2 https://github.com/openwrt/openwrt.git
          cd openwrt
          patch -Np1 < ../config/feeds.main.patch
          git clone --depth=2 https://github.com/openwrt/packages.git feeds/packages 
          git clone --depth=2 https://github.com/openwrt/luci.git feeds/luci  
          git clone --depth=2 https://github.com/openwrt/routing.git feeds/routing
          git clone --depth=2 https://github.com/openwrt/telephony.git feeds/telephony
          ./scripts/feeds update -a
          ./scripts/feeds update -a
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a
          cp ../config/.config .

      - name: Do the build
        run: |
          cd openwrt
          time make -j$(nproc) V=s

      - name: Make release
        run: |
          set -xe
          shopt -s nullglob
          RELDATE="$(date +'%Y-%m-%d %H:%M')"
          NAME="Auto-Build $RELDATE"
          TAGNAME="autobuild-$(date +'%Y-%m-%d-%H-%M')"
          gh release create "$TAGNAME" --target "main" --title "$NAME" openwrt/bin/targets/ath79/generic/*.{bin,buildinfo,manifest,json} openwrt/bin/targets/ath79/generic/sha256sums
          echo "tag_name=${TAGNAME}" >> $GITHUB_OUTPUT
          echo "rel_date=${RELDATE}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ github.token }}
