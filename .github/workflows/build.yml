name: Build firmware for ELECOM WAB-I1750-PS

on:
  schedule:
    - cron: '23 1 * * *'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update and install packages
        run: |
          sudo apt -y purge --auto-remove --purge snapd* firefox*
          sudo apt -y autopurge --auto-remove --purge
          sudo apt -y update
          sudo apt -y full-upgrade --auto-remove --purge
          sudo apt -y install --auto-remove --purge build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          sudo apt -y autopurge --auto-remove --purge
          sudo apt -y autoclean
          sudo apt -y clean

      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout openwrt/openwrt repository
        uses: actions/checkout@v4
        with: 
          repository: openwrt/openwrt
          path: openwrt
          fetch-depth: 1

      - name: Checkout openwrt/packages repository
        uses: actions/checkout@v4
        with: 
          repository: openwrt/packages
          path: openwrt/feeds/packages
          fetch-depth: 1

      - name: Checkout openwrt/luci repository
        uses: actions/checkout@v4
        with: 
          repository: openwrt/luci
          path: openwrt/feeds/luci
          fetch-depth: 1

      - name: Checkout openwrt/routing repository
        uses: actions/checkout@v4
        with: 
          repository: openwrt/routing
          path: openwrt/feeds/routing
          fetch-depth: 1

      - name: Checkout openwrt/telephony repository
        uses: actions/checkout@v4
        with: 
          repository: openwrt/telephony
          path: openwrt/feeds/telephony
          fetch-depth: 1

      - name: Applying customisation
        working-directory: openwrt
        run: patch -Np1 < ../feeds.github.patch

      - name: Setup to build
        working-directory: openwrt
        run: |
          patch -Np1 < ../feeds.github.patch
          ./scripts/feeds update -a
          ./scripts/feeds update -a
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a
          cp ../target_config/ath79_generic_DEVICE_elecom_wab-i1750-ps.config .config
          make defconfig

      - name: Pre-download sources
        working-directory: openwrt
        run: time make -j$(nproc) download

      - name: Do the build
        working-directory: openwrt
        run: time make -j$(nproc)

      - name: Moving artifacts
        run: |
          mkdir -pv artifacts
          cp -r openwrt/bin/targets/ artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
            path: openwrt/bin/targets

  packing:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Make release
        #working-directory: openwrt
        run: |
          ls -laFR
          set -xe
          shopt -s nullglob
          RELDATE="$(date +'%Y-%m-%d %H:%M')"
          NAME="Auto-Build $RELDATE"
          TAGNAME="autobuild-$(date +'%Y-%m-%d-%H-%M')"
          gh release create "$TAGNAME" --target "main" --title "$NAME" artifacts/*
          echo "tag_name=${TAGNAME}" >> $GITHUB_OUTPUT
          echo "rel_date=${RELDATE}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ github.token }}

